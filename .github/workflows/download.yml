name: Fetch NSE Option Chain

on:
  schedule:
    - cron: "*/6 * * * *"  # Run every 6 minutes
  workflow_dispatch:        # Allow manual run

jobs:
  fetch-nse-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository with PAT
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}  # Add your personal access token as GH_PAT in repo secrets

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: pip install requests

    - name: Fetch NSE Option Chain and Save as JSON
      run: |
        import requests, json, datetime

        symbol = 'NIFTY'
        headers = {
            "User-Agent": "Mozilla/5.0",
            "Accept-Language": "en-US,en;q=0.9",
            "Referer": "https://www.nseindia.com"
        }

        session = requests.Session()
        session.headers.update(headers)
        session.get("https://www.nseindia.com", timeout=10)

        url = f"https://www.nseindia.com/api/option-chain-indices?symbol={symbol}"
        response = session.get(url, timeout=10)

        if response.status_code == 200:
            data = response.json()
            now = datetime.datetime.utcnow().strftime("%Y-%m-%d_%H-%M")
            filename = f"option_chain_{now}.json"
            with open(filename, "w") as f:
                json.dump(data, f, indent=2)
        else:
            print("Failed to fetch data")
      shell: python

    - name: Commit and Push
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add option_chain_*.json
        git commit -m "Fetched NSE option chain at $(date)" || echo "No changes to commit"
        git push
